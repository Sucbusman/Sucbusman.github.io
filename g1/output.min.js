var elem,collidableMeshList=[];function checkCollision(e){var t=e.position.clone();log.useText("...");for(var n=!1,i=[],o=0;o<e.geometry.vertices.length;o++){var a=e.geometry.vertices[o].clone().applyMatrix4(e.matrix).sub(e.position),r=new THREE.Raycaster(t,a.clone().normalize(),0,50).intersectObjects(collidableMeshList);if(r.length>0&&r[0].distance<a.length()&&(n=!0,log.addText("hit! "),r[0].face)){var s=r[0].face.normal;log.addText(`normal:${s.x} ${s.y} ${s.z}\n`),i.push(s)}}return{iscollision:n,normals:i}}var cube,stats,log,stop=!0;function fullscreenChange(){document.webkitFullscreenElement!==elem&&document.mozFullscreenElement!==elem&&document.mozFullScreenElement!==elem||(elem.requestPointerLock=elem.requestPointerLock||elem.mozRequestPointerLock||elem.webkitRequestPointerLock,elem.requestPointerLock(),stop=!1,gameStart())}function pointerLockChange(){document.pointerLockElement?console.log("pointer still lock"):(console.log("pointer unlock"),stop=!0,gameStop())}function pointerLockError(){console.log("lock point error!")}function lockPointer(){(elem=document.getElementById("canvas-frame")).requestFullscreen=elem.requestFullscreen||elem.mozRequestFullscreen||elem.mozRequestFullScreen||elem.webkitRequestFullscreen,elem.requestFullscreen()}document.addEventListener("fullscreenchange",fullscreenChange,!1),document.addEventListener("mozfullscreenchange",fullscreenChange,!1),document.addEventListener("webkitfullscreenchange",fullscreenChange,!1),document.addEventListener("pointerlockchange",pointerLockChange,!1),document.addEventListener("mozpointerlockchange",pointerLockChange,!1),document.addEventListener("webkitpointerlockchange",pointerLockChange,!1),document.addEventListener("pointerlockerror",pointerLockError,!1),document.addEventListener("mozpointerlockerror",pointerLockError,!1),document.addEventListener("webkitpointerlockerror",pointerLockError,!1);var mixer,clock=new THREE.Clock,center={x:document.getElementById("canvas-frame").clientWidth/2,y:document.getElementById("canvas-frame").clientHeight/2};function gameStart(){initCallback(),animate()}function gameStop(){drawbackCallback()}async function threeStart(){initThree(),initLog(),initCamera(),initScene(),initLight(),await initSpirit(),initObject(),initResize(),renderer.clear(),initStates()}function initThree(){renderer=new THREE.WebGLRenderer,renderer.setSize(2*center.x,2*center.y),document.getElementById("canvas-frame").appendChild(renderer.domElement),renderer.setClearColor(12303359,1)}function initCamera(){camera=new THREE.PerspectiveCamera(50,center.x/center.y,1,300),camera.position.set(spirit.initx,spirit.tall+spirit.inity,spirit.initz-spirit.viewdis),camera.lookAt(0,0,100)}function initScene(){scene=new THREE.Scene}function initLight(){light1=new THREE.AmbientLight(16777215,.7),light2=new THREE.DirectionalLight(16733474,.8);var e=new THREE.Object3D;e.position.set(10,0,0),light2.position.set(-20,0,0),light2.target=e,light3=new THREE.PointLight(65280,.7,100),light3.position.set(50,50,50),light4=new THREE.SpotLight(255,1,300,Math.PI/4),light4.position.set(0,100,0),light5=new THREE.PointLight(1044480,.9,100),light5.position.set(100,50,100),scene.add(light1)}function objGrid(){var e=new THREE.Geometry,t=new THREE.LineBasicMaterial({color:16711731});e.vertices.push(new THREE.Vector3(0,-20,0)),e.vertices.push(new THREE.Vector3(0,20,0));for(var n=-20;n<21;n+=2){let i=new THREE.Line(e,t,THREE.LineSegments);i.position.x=n,scene.add(i)}for(var i=-20;i<21;i+=2){let n=new THREE.Line(e,t,THREE.LineSegments);n.rotation.z=90*Math.PI/180,n.position.y=i,scene.add(n)}}function objBox(){var e=new THREE.BoxBufferGeometry(20,50,15),t=new THREE.MeshLambertMaterial({color:12298769}),n=new THREE.Mesh(e,t);n.position.set(0,0,-20),collidableMeshList.push(n),scene.add(n)}function initMap(){var e=10,t=5,n=10;let i={},o=map.length;i.x=50*-e/2,i.z=50*-n/2;for(var a=0;a<o;a++)for(var r=0;r<o;r++)if(map[a][r]){randHex=16777215*Math.random();let o=new THREE.BoxBufferGeometry(e,t+40*Math.random(),n),s=new THREE.MeshLambertMaterial({color:randHex}),l=new THREE.Mesh(o,s);l.position.set(i.x+r*e,2,i.z+a*n),collidableMeshList.push(l),scene.add(l)}}function objEnv(){var e=new THREE.BoxBufferGeometry(2e3,10,2e3),t=new THREE.MeshLambertMaterial({color:16777215}),n=new THREE.Mesh(e,t);n.position.set(0,-10,0),collidableMeshList.push(n),scene.add(n),initMap()}function initObject(){objEnv()}function initCallback(){document.addEventListener("keydown",keyDown),document.addEventListener("keyup",keyUp),document.addEventListener("mousemove",mouseMove),document.addEventListener("mousedown",mouseDown),document.addEventListener("mouseUp",mouseUp)}function drawbackCallback(){document.removeEventListener("keydown",keyDown),document.removeEventListener("keyUp",keyUp),document.removeEventListener("mousemove",mouseMove),document.removeEventListener("mousedown",mouseDown),document.removeEventListener("mouseup",mouseUp)}function initStates(){(stats=new Stats).setMode(0),stats.dom.style.position="absolute",stats.dom.style.left="0px",stats.dom.style.top="0px",document.getElementById("canvas-frame").appendChild(stats.dom)}function initLog(){log=myPanel(),bloodTrough=BloodTrough(),bloodTrough.update(),log.dom.style.position="absolute",log.dom.style.left="100px",log.dom.style.top="0px",log.useText("it may take some time..."),document.getElementById("canvas-frame").appendChild(log.dom),document.getElementById("canvas-frame").appendChild(bloodTrough.dom)}function initResize(){window.addEventListener("resize",(e=>{center.x=document.getElementById("canvas-frame").clientWidth/2,center.y=document.getElementById("canvas-frame").clientHeight/2,camera.aspect=center.x/center.y,camera.updateProjectionMatrix(),renderer.setSize(2*center.x,2*center.y)}),!1)}function animate(){if(!stop){requestAnimationFrame(animate),spiritMoveCheck(.8);var e=clock.getDelta();mixer.update(e),renderer.render(scene,camera),stats.update()}}var map=[[1,1,1,1,0,0,1,1,0,0,0,0,0,1,1,1,0,1,1,0,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,1],[1,1,1,1,0,1,0,1,0,0,1,1,1,0,1,1,0,1,1,0,1,1,0,0,1,0,1,0,0,0,0,0,1,0,1,1,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,1],[0,1,0,1,1,0,1,0,1,1,1,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,1,0,0,1,0,0,1,0,1,0,0,1,1,0],[1,1,0,1,1,1,0,0,0,1,0,0,0,1,0,0,1,1,1,0,0,0,0,0,0,0,1,0,0,1,0,1,1,0,1,1,0,1,0,0],[0,1,0,1,1,1,0,1,0,1,0,1,0,0,0,0,0,1,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,1,0,0,0,0,0,1,1,1,1,0,1,0,1,1,1,0,0,1,0,1,1,1,1,0,0,1,0,0,0,0,1,1,0,0,0,1,0,0],[0,0,0,1,1,1,0,1,0,0,1,0,1,0,1,0,1,1,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,1,1,0,0,0],[0,0,0,1,0,1,0,1,0,1,1,0,1,0,1,0,0,0,0,0,0,1,0,0,0,0,1,1,0,1,1,0,1,0,1,1,0,1,0,1],[1,1,0,0,0,1,0,1,0,1,1,0,1,0,0,0,1,0,1,1,1,0,0,0,0,1,0,0,0,0,0,1,1,0,0,1,0,0,1,0],[0,1,0,1,1,0,1,1,0,0,0,1,0,0,0,0,1,0,1,0,1,1,1,1,0,1,0,1,1,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1,0,0,0,1,1,1,0,0,1,0,0,0,1,1,0,0,1,1,0,1,0,1,1,0,1,0,0,1,0,1,0,1],[0,1,1,0,1,1,0,1,0,1,1,0,0,0,0,0,0,1,1,1,0,1,0,0,0,1,0,0,1,0,1,0,0,0,1,0,0,1,0,0],[0,1,1,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,0],[0,0,1,0,0,1,0,0,0,0,1,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,1,1,1,1,1],[0,1,1,1,1,1,1,0,0,1,0,0,1,0,1,0,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,0,1,0,0,0,1,1,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,1,0,1,0,1,1,0,0,1,0,0,1,0],[0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,1,0,1,0,0,1,0,0,1,1,0,1,1],[0,0,1,0,0,1,0,0,0,1,1,1,0,0,1,0,0,1,0,0,0,1,0,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0,0,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,1,0,1,1,0,1,0,0,0],[0,1,1,1,0,0,1,1,1,1,0,1,1,0,0,0,0,0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,0,1,1,1,1,0,1,0],[0,0,0,1,1,0,0,0,1,1,0,1,0,1,1,0,1,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,1,1,0,0,0,1],[1,0,0,0,1,0,0,0,0,0,1,0,0,1,0,1,1,0,1,1,1,0,0,0,1,0,1,1,0,1,1,1,0,0,0,0,1,1,0,1],[1,1,1,0,1,1,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,0,1,0,0,0,0,0,0,0,1],[1,1,1,1,1,0,1,1,0,1,1,0,0,1,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,0,0,0,0,1,1,0,0,0,0,0],[1,1,1,0,1,1,0,0,0,1,1,0,0,0,1,0,1,0,1,1,1,0,1,1,0,1,0,1,1,0,0,0,0,0,1,1,1,1,1,0],[1,0,0,0,1,0,1,0,0,0,0,1,1,0,0,1,0,0,0,0,0,1,1,0,0,0,1,1,0,1,1,0,0,0,0,0,0,1,0,0],[1,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,1,1,0,0,0,1,0,0,0,0,1,0,0,0,1,0,0,1,0,1,1,0,1],[0,0,0,0,0,1,0,1,0,1,1,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,1,0,0,1,0,0,0,1,1],[0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1,0,0],[0,0,0,0,1,1,1,0,0,0,0,0,1,1,0,1,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,0,0,1,1,1,1,0,0,0,1,1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0,1,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,0,0,1,1,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0],[1,0,0,0,0,0,0,1,1,0,0,0,1,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,0,0,0,1,0,0,0,1,0,0],[0,0,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0,1,1],[1,0,0,0,1,0,0,1,1,1,0,0,0,0,0,1,1,0,0,1,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,0,0,1,1,0,1,0,0,0,0,1,0,0,1,1,0,1,0,1,1,1,0,0,0,0,0,0,1,0,1,0,0,1,1],[0,0,1,1,0,1,0,1,1,1,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,1,1,0,1,1,0,1,1,1,0,0,0,0],[0,0,0,1,0,1,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,1,1,1,0,1,1,1,1,1,0,1,0,0,0,0,1,0,1],[1,0,0,0,0,0,1,1,1,1,1,0,1,1,1,0,0,0,0,0,1,0,0,1,0,1,0,0,1,1,1,0,0,0,1,1,0,0,0,1]];function towardsxyz(e,t){let n=Math.tan(e),i=Math.tan(t),o=Math.sqrt(1/(n**2+i**2*n**2+i**2+1)),a=e;e<0&&(a*=-1),2*a>=Math.PI&&2*a<=3*Math.PI&&(o*=-1);let r=-o*n,s=i*Math.sqrt(o**2+r**2),l=t;return 2*l>=Math.PI&&2*l<=3*Math.PI&&(s*=-1),new THREE.Vector3(o,s,r)}function faceProject(e,t){if(e.dot(t)>=0)return e;let n=e.clone().cross(t),i=t.cross(n).normalize();return i.multiplyScalar(e.dot(i))}function vecAngle(e,t){return e.dot(t)/(e.length()*t.length())}var myPanel=function(){var e=document.createElement("div");e.style.cssText="pointer-events:none;position:fixed;top:0;left:0;opacity:0.8;z-index:1200;color:aqua;",e.addEventListener("click",(e=>{e.preventDefault()}));var t=document.createElement("canvas");t.width=window.innerWidth,t.height=window.innerHeight,e.appendChild(t);var n=t.getContext("2d");return{dom:e,ctx:n,addDom:function(t){return e.appendChild(t),panel},useImg:function(e){var t=new Image(e);n.drawImage(t)},useText:function(t){e.innerText=t},clear:function(){n.clearRect(0,0,t.width,t.height)},addText:function(t){e.innerText+=t},rectangle:function(e,t,i,o,a){n.fillStyle=a,n.fillRect(e,t,i,o)}}};function BloodTrough(){var e=myPanel(),t={life:100,update:function(){e.clear(),e.rectangle(100,0,10*t.life,30,"#FF0000")}};return Object.assign(e,t)}var spirit={initx:0,inity:40,initz:-80,tall:1,scale:.3,theta:Math.PI/2,rotateOffsetY:0,viewdis:6,rotateSensitive:1e-4,mode:"tps",modeSet:function(e){switch(this.mode=e,e){case"fps":this.tall=.3,this.viewdis=.3,this.mesh.children[0].visible=!1;break;case"tps":this.tall=1,this.viewdis=5,this.mesh.children[0].visible=!0}},switchlight:function(){spirit.mesh.children[1]&&(0==spirit.mesh.children[1].visible?(spirit.mesh.children[1].visible=!0,setTimeout((()=>{spirit.mesh.children[1].visible=!1}),5e3)):spirit.mesh.children[1].visible=!1)},status:new Map};function initSpirit(){var e=new THREE.BoxGeometry(2,2.5,4),t=new THREE.MeshBasicMaterial({color:11184640,visible:!1}),n=new THREE.Mesh(e,t);n.position.set(spirit.initx,spirit.inity,spirit.initz),spirit.mesh=n,scene.add(spirit.mesh),(new THREE.GLTFLoader).load("snowCow/snowCow.gltf",(e=>{console.log(e),cow=e.scene.children[0],cow.position.set(0,0,2),cow.scale.set(1,1,1),cow.rotateX(-Math.PI/2),mixer=new THREE.AnimationMixer(cow);var t=e.animations,n=THREE.AnimationClip.findByName(t,"walk"),i=THREE.AnimationClip.findByName(t,"jump"),o=THREE.AnimationClip.findByName(t,"slide"),a=THREE.AnimationClip.findByName(t,"attack");walkAction=mixer.clipAction(n),jumpAction=mixer.clipAction(i),slideAction=mixer.clipAction(o),attackAction=mixer.clipAction(a),walkAction.setLoop(THREE.LoopRepeat),walkAction.repetitions=1,jumpAction.setLoop(THREE.LoopRepeat),jumpAction.repetitions=1,slideAction.setLoop(THREE.LoopRepeat),slideAction.repetitions=1,attackAction.setLoop(THREE.LoopRepeat),attackAction.repetitions=1,spirit.mesh.add(cow);let r=new THREE.PointLight(16746496,.4,100);spirit.mesh.add(r),r.visible=!1,log.useText("model load finished!"),document.getElementById("startbtn").disabled=!1}),void 0,(e=>{console.error(e)}))}var Stats=function(){var e=0,t=document.createElement("div");function n(e){return t.appendChild(e.dom),e}function i(n){for(var i=0;i<t.children.length;i++)t.children[i].style.display=i===n?"block":"none";e=n}t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",(function(n){n.preventDefault(),i(++e%t.children.length)}),!1);var o=(performance||Date).now(),a=o,r=0,s=n(new Stats.Panel("FPS","#0ff","#002")),l=n(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=n(new Stats.Panel("MB","#f08","#201"));return i(0),{REVISION:16,dom:t,addPanel:n,showPanel:i,begin:function(){o=(performance||Date).now()},end:function(){r++;var e=(performance||Date).now();if(l.update(e-o,200),e>=a+1e3&&(s.update(1e3*r/(e-a),100),a=e,r=0,c)){var t=performance.memory;c.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){o=this.end()},domElement:t,setMode:i}};Stats.Panel=function(e,t,n){var i=1/0,o=0,a=Math.round,r=a(window.devicePixelRatio||1),s=80*r,l=48*r,c=3*r,d=2*r,m=3*r,p=15*r,u=74*r,h=30*r,f=document.createElement("canvas");f.width=s,f.height=l,f.style.cssText="width:80px;height:48px";var E=f.getContext("2d");return E.font="bold "+9*r+"px Helvetica,Arial,sans-serif",E.textBaseline="top",E.fillStyle=n,E.fillRect(0,0,s,l),E.fillStyle=t,E.fillText(e,c,d),E.fillRect(m,p,u,h),E.fillStyle=n,E.globalAlpha=.9,E.fillRect(m,p,u,h),{dom:f,update:function(l,v){i=Math.min(i,l),o=Math.max(o,l),E.fillStyle=n,E.globalAlpha=1,E.fillRect(0,0,s,p),E.fillStyle=t,E.fillText(a(l)+" "+e+" ("+a(i)+"-"+a(o)+")",c,d),E.drawImage(f,m+r,p,u-r,h,m,p,u-r,h),E.fillRect(m+u-r,p,r,h),E.fillStyle=n,E.globalAlpha=.9,E.fillRect(m+u-r,p,r,a((1-l/v)*h))}}};var theta=Math.PI/2,alpha=0,towards=new THREE.Vector3(0,0,1);function mouseDown(e){if(0==e.button){playIfNotRun(attackAction,1);let e=spirit.mesh.position.clone(),t=towardsxyz(theta,alpha+.3);e.add(t.clone().multiplyScalar(8));let n=e.x,i=e.y,o=e.z,a=new THREE.BoxBufferGeometry(7,7,7),r=new THREE.Mesh(a);r.lookAt(t),r.name="block",r.position.set(n,i,o),scene.add(r),console.log(r),collidableMeshList.push(r)}else if(2==e.button){let e=spirit.mesh.position.clone(),t=towardsxyz(theta,alpha+.3);e.add(t.clone().multiplyScalar(8));let n=e.x,i=e.y,o=e.z,a=new THREE.BoxGeometry(7,7,7),r=new THREE.Mesh(a);r.lookAt(t),r.name="attack",r.position.set(n,i,o),scene.add(r),console.log(r),collidableMeshList.push(r)}}function mouseUp(e){0==e.button&&playIfNotRun(attackAction,0)}function tpcameraUpdate(){let e=spirit.mesh,t=e.position.x-towards.x*spirit.viewdis,n=e.position.y-towards.y*spirit.viewdis+spirit.tall,i=e.position.z-towards.z*spirit.viewdis;camera.position.set(t,n,i),camera.lookAt(e.position.x,e.position.y+spirit.tall,e.position.z)}function mouseMove(e){let t=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;alpha-=.001*n,alpha%=2*Math.PI,theta-=.001*t,theta%=2*Math.PI,spirit.mesh.rotateY(theta-spirit.theta),spirit.theta=theta,towards=towardsxyz(theta,alpha),tpcameraUpdate()}function keyDown(e){e.preventDefault?e.preventDefault():window.event.returnValue=!1,e.key in keyStatus?keyStatus[e.key]=!0:32==e.keyCode?keyStatus.space=!0:"m"==e.key?"fps"==spirit.mode?spirit.modeSet("tps"):spirit.modeSet("fps"):"l"==e.key&&spirit.switchlight()}function keyUp(e){e.preventDefault?e.preventDefault():window.event.returnValue=!1,e.key in keyStatus?keyStatus[e.key]=!1:32==e.keyCode&&(keyStatus.space=!1)}keyStatus={a:!1,d:!1,w:!1,s:!1,f:!1,space:!1};var gravity={direction:new THREE.Vector3(0,-.5,0),scale:.5};function spiritMoveCheck(e){var t=spirit.mesh,n=towards.clone(),i=n.clone().setY(0).length(),o=new THREE.Vector3(0,0,0),a=!1,r=!1;keyStatus.a&&(o.add(leftTrans(n)),r=!0),keyStatus.d&&(o.add(rightTrans(n)),r=!0),keyStatus.w&&(o.add(forwardTrans(n)),a=!0),keyStatus.s&&(o.add(backwardTrans(n)),a=!0),o=o.normalize().multiplyScalar(.5*i),spirit.status.has("ON_THE_JUMP")?o.add(goUp()):(playIfNotRun(walkAction,a),playIfNotRun(slideAction,r)),keyStatus.space&&spirit.status.has("ON_THE_GROUND")&&(o.add(goUp()),e*=4,spirit.status.set("ON_THE_JUMP",1),spirit.status.delete("ON_THE_GROUND"),jumpAction.play(),setTimeout((()=>{spirit.status.delete("ON_THE_JUMP")}),500)),o=o.add(goDown());var s=checkCollision(t);if(log.addText(`movement:${o.x} ${o.y} ${o.z}\n`),s.iscollision){log.addText(`pre direction:${n.x} ${n.y} ${n.z}\n`);let i=o;for(var l=0;l<s.normals.length;l++)vecAngle(s.normals[l],spirit.mesh.up)>.7&&(spirit.status.set("ON_THE_GROUND",1),jumpAction.stop()),i=faceProject(i,s.normals[l]);log.addText(`after faceProject:${i.x} ${i.y} ${i.z}\n`),spiritMove(t,i,e)}else spiritMove(t,o,e);tpcameraUpdate()}function spiritMove(e,t,n){e.position.add(t.multiplyScalar(n))}function leftTrans(e){return new THREE.Vector3(e.z,0,-e.x)}function rightTrans(e){return new THREE.Vector3(-e.z,0,e.x)}function forwardTrans(e){return new THREE.Vector3(e.x,0,e.z)}function backwardTrans(e){return new THREE.Vector3(-e.x,0,-e.z)}function goUp(e=1){return gravity.direction.clone().multiplyScalar(-2*e)}function goDown(){return gravity.direction.clone()}function spiritDrop(e,t){e.position.y>=spirit.tall&&(e.position.y-=1*t)}function playIfNotRun(e,t){t?e.isRunning()||(e.stop(),e.play()):e.isRunning()||e.stop()}